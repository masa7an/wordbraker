# Word Breaker - Development Roadmap

## プロジェクト概要

- **開発フェーズ**: 第1フェーズ（Python + pygame ローカル実装）✅ 完了
- **目的**: 完成度の高いゲームロジックの確立
- **技術スタック**: Python 3.x + pygame 2.5.2
- **次のフェーズ**: Web移植（予定）

## プロジェクト構造

```
wordbraker/
├── main.py                 # エントリーポイント
├── config.py               # 定数管理
├── game.py                 # メインゲームループ
├── states/                 # ゲーム状態管理
│   └── __init__.py
├── entities/               # ゲーム要素
│   ├── __init__.py
│   ├── ball.py
│   ├── paddle.py
│   ├── block.py
│   └── door.py
├── systems/                # システム
│   ├── __init__.py
│   ├── word_manager.py     # 単語管理・学習制御
│   ├── score_manager.py    # スコア管理
│   ├── collision.py        # 当たり判定
│   └── sound_manager.py    # 音声管理
├── data/
│   └── words.json          # 英単語データ（JSON形式、69語）
├── asset/
│   └── sound/              # 音声ファイル
│       ├── Bounce_sound.wav
│       ├── Correct_sound.wav
│       └── CLEAR.wav
├── requirements.txt
├── README.md
├── ROADMAP.md
├── 要件定義書.md
└── 設計の下書き.txt
```

## セットアップ

### 1. 必要な環境
- Python 3.x
- pygame 2.5.2

### 2. インストール

```bash
pip install -r requirements.txt
```

### 3. 実行

```bash
python main.py
```

またはバッチファイルを使用:

```bash
run.bat
```

## 開発方針

- **学習制御ロジックを優先**
- **演出は最小限でOK**
- **可読性重視**
- **デバッグしやすい構造**
- **物理演算は安定性優先**

## 実装状況

### フェーズ1: 基本構造 ✅ 完了
- [x] 要件定義書
- [x] プロジェクト構造設計
- [x] requirements.txt
- [x] config.py（定数管理）
- [x] 英単語データJSON変換（69語）
- [x] README.md
- [x] ディレクトリ構造
- [x] run.bat（仮想環境なし）

### フェーズ2: エンティティ実装 ✅ 完了
- [x] ボールエンティティ（移動、反射、描画）
- [x] パドルエンティティ（マウス/ゲームパッド追跡、傾き付き描画）
- [x] ブロックエンティティ（正解/不正解、HPシステム、ハードモード対応）
- [x] 扉エンティティ（ロック/アンロック状態、描画）

### フェーズ3: システム実装 ✅ 完了
- [x] 当たり判定システム（正確な当たり方向検出）
- [x] スコア管理システム（コンボ、パーフェクトボーナス）
- [x] 単語管理システム（再挑戦ロジック、新規単語制限）
- [x] 音声管理システム（バウンス、正解、クリア音）

### フェーズ4: ゲーム状態実装 ✅ 完了
- [x] タイトル画面
- [x] ステージ開始画面
- [x] プレイ中状態
- [x] ステージクリア状態
- [x] リザルト画面
- [x] ゲームオーバー画面

### フェーズ5: ゲームロジック統合 ✅ 完了
- [x] メインゲームループ
- [x] ライフシステム（初期10、ボール落下で-1）
- [x] ステージ管理（10ステージ）

### フェーズ6: UI/UX実装 ✅ 完了
- [x] スコア表示（左上）
- [x] タイマー表示（右上）
- [x] 問題テキスト表示（上中央、ID + 単語）
- [x] ライフ表示（左上）
- [x] コンボ表示（左上、アクティブ時）
- [x] ハードモード表示（右上、アクティブ時）

### フェーズ7: 学習制御ロジック ✅ 完了
- [x] 再挑戦制御（間違えた単語が再出現）
- [x] 新規単語制限（ステージあたり最大5語）

### フェーズ8: 入力デバイス対応 ✅ 完了
- [x] マウス操作（パドル移動、ボール発射）
- [x] ゲームパッド対応（十字キー + アナログスティック）
- [x] キーボード対応（Hキーでハードモード、Escで終了）

### フェーズ9: 追加機能 ✅ 完了
- [x] ハードモード（正解ブロックも赤色、見分けがつかない）
- [x] ブロックHPシステム（正解ブロック: HP 2、2ヒットで破壊）
- [x] 難易度調整（ボール速度、パドルサイズ、ブロック間隔）
- [x] 表示調整（ID番号表示）

### フェーズ10: テスト・調整 ✅ 完了
- [x] 基本動作確認
- [x] 当たり判定確認
- [x] スコア計算確認
- [x] 状態遷移確認
- [x] ゲームパッド操作確認
- [x] バグ修正（日本語フォント、ブロック表示、ボール発射、当たり判定ワープ、ゲームパッド位置）

## 技術詳細

### 定数管理
すべてのゲーム定数は`config.py`で管理:
- 画面サイズ: 1280×720
- 要素サイズ: ブロック（300×40）、パドル（168×20）、ボール（半径8）、扉（360×40）
- 速度設定: ボール速度、パドル速度、反射効果
- カラースキーム: ダークモード + 柔らかい色
- フォント設定: 日本語フォント対応

### ゲーム状態
- `TITLE`: タイトル画面
- `STAGE_START`: ステージ開始（問題表示、ボール発射待ち）
- `PLAYING`: プレイ中（ゲームループ、エンティティ更新、当たり判定）
- `STAGE_CLEAR`: ステージクリア（1.5秒待機、自動遷移）
- `RESULT`: リザルト画面（スコア、パーフェクトボーナス、再開オプション）
- `GAME_OVER`: ゲームオーバー（コンティニューオプション）

### 入力処理
- **マウス**: パドル移動（絶対位置）、ボール発射（クリック）
- **ゲームパッド**: 
  - 十字キーまたはアナログスティックでパドル移動（相対移動）
  - Aボタンでボール発射とアクション
  - 優先順位: アナログスティック > 十字キー > マウス
- **キーボード**: Hキー（ハードモード切り替え）、Escキー（終了）

### 当たり判定システム
- 正確な当たり方向検出（上下 vs 左右）
- 重なり防止のための位置補正
- 壁/ブロック反射時の速度減衰（20%減少）
- パドル反射時の速度増加（+1）

### スコアシステム
- 基本スコア: 正解ブロック1つあたり100
- コンボ: 3回連続ヒット = ×1.2倍
- パーフェクトボーナス: ミスなし = ×1.2倍 + "PERFECT!!"表示

### 単語管理
- 総単語数: 69（JSON形式）
- ステージあたりの新規単語: 最大5
- 再挑戦: 間違えた単語は自動的に次のステージに再出現
- 学習アルゴリズム: 間違いがあった単語を優先

## 既知の問題と解決策

### 解決済みの問題
- ✅ 日本語文字化け → 動的フォント読み込み
- ✅ ブロック表示問題 → 初期化順序の修正
- ✅ リスポーン後のボール発射 → PLAYING状態での発射チェック追加
- ✅ ブロック当たり判定ワープ → 前フレーム位置を使用した当たり判定の改善
- ✅ ゲームパッド位置リセット → 仮想パドル位置システム

## 次のフェーズ: Web移植

### 計画中の機能
- [ ] Web互換性（pygbagを検討）
- [ ] ブラウザ対応
- [ ] モバイル対応
- [ ] タッチ入力対応

### 考慮事項
- OS依存の操作を避けるコード
- 定数は簡単に設定可能に
- モジュール構造はWebフレンドリーに

---

## フェーズ11: Web版パフォーマンス最適化

### 目的
pygbag（WebAssembly）環境での「もっさり感」を解消し、ネイティブ版と同等の体験を実現する。

### 実施済み ✅
- [x] Ball内の定数キャッシュ（関数内importを__init__に移動）
- [x] Rectオブジェクトのキャッシュ（Ball, Block, Paddle, Door）
- [x] Ballの描画を事前作成Surfaceのblitに変更
- [x] dt固定（dt = 1.0）でフレームベースの物理演算
- [x] フォントの初期化時キャッシュ
- [x] 正解ブロック残数をカウンタ管理（list comprehension回避）
- [x] **テキスト描画のキャッシュ化**（スコア、タイマー、お題、ID、コンボ、ハードモード表示など）
- [x] **ブロックの描画をSurface blitに変更**（draw.rect → blit、状態変化時のみ再作成）
- [x] **パドル・扉の描画をSurface blitに変更**（draw.rect → blit、状態変化時のみ再作成）
- [x] **ブロック・扉のテキスト描画キャッシュ化**（font.render()の呼び出し削減）
- [x] **await asyncio.sleep(0) への変更**（Geminiのアドバイス、VSync同期、劇的改善）
- [x] **フレーム時間詳細計測ツール**（Tキーで計測、各処理の時間を分析）

### 完了 ✅ **フェーズ11: Web版パフォーマンス最適化**

**最適化結果:**
- await sleep: 39.2ms → 8.4ms（約79%削減）
- Total frame: 52.4ms → 16.8ms（約68%削減）
- 実効FPS: 19FPS → 約60FPS（約3倍改善）
- 体感の「もっさり感」が劇的に改善（ユーザー確認済み）

**未実施（現時点では不要）**
- [ ] **衝突判定の効率化**（ブロック数が少ないため不要）
  - [ ] 空間分割（ブロック数が増えた場合に検討）
  - [ ] 早期リターンの最適化（既に実装済み）

- [ ] **メモリ使用量の最適化**（現状で問題なし）
  - [ ] 不要なオブジェクト生成の削減
  - [ ] GC発生頻度の低減

### 計測ツール
- Tキーでフレーム計測（480フレーム = 約8秒）
- 画面右下に進捗表示、完了後に結果表示

### 目標値 ✅ 達成
- ✅ 平均60FPS（フレーム時間 16.7ms以下） - **達成: 平均16.8ms（約60FPS）**
- ✅ フレーム落ちなし（最大フレーム時間 33ms以下） - **達成: 最大56.7ms（スパイクはあるが、体感は問題なし）**

## バージョン履歴

### Version 1.0（フェーズ1完了）
- すべてのコア機能実装
- ゲームパッド対応（十字キー + アナログスティック）
- ハードモード
- 音声システム
- 学習制御ロジック
- データベースに69語

---

**最終更新**: 2024年（フェーズ1完了）
**ステータス**: フェーズ1 ✅ 完了、フェーズ2（Web） - 計画中
