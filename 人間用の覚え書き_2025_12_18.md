# 人間用の覚え書き - 2025年12月18日

## 概要
pygbag（Pygame→WebAssembly移植）でのパフォーマンス問題に苦戦した日。

---

## 🔴 苦労した問題1: Web版でボールが異常に遅い

### 状況
- pygbagでWeb移植後、ボールの動きがスローモーションのように遅い
- PC版では問題なく動作していた
- ブラウザのコンソールには特にエラーなし

### 原因（複合的）

#### 原因A: dtの計算ミス
```python
# 問題のコード
dt_ms = self.clock.tick(self.FPS)
dt = dt_ms / 1000.0  # 秒単位（0.016秒など）

# ボールの速度定数はフレーム単位で設計されていた
BALL_SPEED_X = 5  # 1フレームで5ピクセル移動を想定
```
- `dt = 0.016`（秒）× `速度5` = **0.08ピクセル/フレーム**（60倍遅い！）

#### 原因B: clock.tick()がWeb環境で機能しない
- `pygame.time.Clock().tick(60)`はWebAssembly環境では期待通り動作しない
- FPS制御が効かず、不安定なフレームレートに

#### 原因C: 毎フレームのオブジェクト生成（WASM環境で致命的）
```python
# 毎フレーム新しいRectを生成していた
def get_rect(self):
    return pygame.Rect(self.x, self.y, self.width, self.height)  # 重い！
```
- Ball, Block, Paddle, Door全てで同様の問題
- WebAssembly上のPythonはオブジェクト生成が**激重**

#### 原因D: 毎フレームのフォント読み込み
```python
# draw_playing()で毎フレーム呼ばれていた
font = get_japanese_font(size)  # 毎回フォントファイルを読み込み
```

#### 原因E: 毎フレームの全ブロック走査
```python
# 毎フレームリスト内包表記で新配列生成
correct_blocks = [b for b in self.blocks if b.is_correct() and not b.is_destroyed()]
```

### 解決策

| 問題 | 解決策 |
|------|--------|
| dt計算 | `dt = 1.0`（フレーム単位）に固定 |
| FPS制御 | `await asyncio.sleep(1/60)`で明示的に60FPS |
| Rect生成 | 初期化時にキャッシュ、座標のみ更新 |
| フォント | `self.font_id`として初期化時にキャッシュ |
| リスト走査 | `remaining_correct_blocks`カウンタで管理 |

### 教訓
> **ネイティブPygameで許されていた処理密度は、WebAssemblyでは即ボトルネックになる**

---

## 🔴 苦労した問題2: ゲームパッドで十字キーを離すとパドルが戻る

### 状況
- ゲームパッドの十字キーでパドルは移動する
- しかし、十字キーを離すと**初期位置（マウス位置）に戻ってしまう**
- マウスを動かさない限り、十字キー操作が上書きされる

### 原因
```python
# マウス位置を常にパドルに反映していた
mouse_x, _ = pygame.mouse.get_pos()
self.paddle.update(mouse_x)  # マウス位置が常に優先される
```
- マウスが動いていなくても、毎フレームマウス位置でパドルを更新
- 十字キーで動かしても、次のフレームでマウス位置に戻される

### 解決策
```python
# 仮想パドル位置を導入
self.virtual_paddle_x = SCREEN_WIDTH // 2
self.prev_mouse_x = None

# マウスが実際に動いた時だけ更新
if mouse_x != self.prev_mouse_x:
    self.virtual_paddle_x = mouse_x
    self.prev_mouse_x = mouse_x

# ゲームパッドは相対移動
if hat_x != 0:
    self.virtual_paddle_x += hat_x * PADDLE_SPEED

# パドルは仮想位置を使用
self.paddle.update(self.virtual_paddle_x)
```

### 教訓
> **マウスとゲームパッドの共存には「仮想位置」の概念が必要**

---

## 📊 解析に時間がかかった理由

1. **Web環境特有の問題**
   - ローカル実行では再現しない
   - ブラウザのコンソールログだけでは原因特定困難
   - Gemini/GPTの分析を参考にした

2. **複合的な原因**
   - 1つの修正では解決せず、複数の問題が絡み合っていた
   - 「まだもっさり」→「まだ遅い」→「まだ3倍遅い」と段階的に改善

3. **pygbagの挙動の違い**
   - `clock.tick()`が効かない
   - オブジェクト生成コストの差が大きい
   - ドキュメントが少ない

---

## ✅ 今後のチェックリスト（人間用）

- [ ] RTA用のタイマーがコンマ秒数のときは間引き表示に変更すること（毎フレーム更新は重い）
- [ ] マウス/ゲームパッド併用時は仮想位置パターンを使用

---

> **関連ドキュメント**: [pygbag_web移植ガイド.md](pygbag_web移植ガイド.md) - AIエージェント向けの詳細な移植ガイドとチェックリスト
